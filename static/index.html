<!doctype html>
<html lang="en">
<head>
  <style>
    html, body {padding:0; margin: 0; height: 100%; background: #000000}
    #particles-js{
      width: 100%;
      height: 300px;
      background-color: #000;
      background-image: url('');
      background-size: cover;
      background-position: 50% 50%;
      background-repeat: no-repeat;
    }
    .chat-box {
      position: fixed;
      transform: translate(20px, 30px);
      font-family: Arial;
      font-weight: lighter;
      font-size: 12px;
      color: rgba(255,255,255,.8);
      width: 300px;
      height: 500px;
      border:solid 1px rgba(255,255,255,.4);
      padding: 5px;
      overflow-y: scroll;
    }
    .message {

    }

    .pin-bottom {
      position: absolute;
      bottom: 0;
      width: 300px;
    }
  </style>
  <script src="./js/clmtrackr.js"></script>
  <script src="./js/particles.js"></script>
</head>
<body>
  <video style="display: none" id="video" width="100" height="100" preload="auto" playsinline autoplay></video>
  <div id="particles-js"/>
  <script>
    particlesJS('particles-js', {
      "particles": {
        "number": {
          "value": 780,
          "density": {
            "enable": false,
            "value_area": 481.0236182596568
          }
        },
        "color": {
          "value": "#CCC"
        },
        "size": {
          "value": 0,
          "random": true,
          "anim": {
            "enable": false,
            "speed": 5,
            "size_min": 0.1,
            "sync": true
          }
        },
        "line_linked": {
          "enable": true,
          "distance": 35.10236182596568,
          "color": "#ffffff",
          "opacity": .7,
          "width": .5
        },
        "move": {
          "enable": true,
          "speed": 1,
          "direction": "none",
          "random": false,
          "straight": false,
          "out_mode": "out",
          "bounce": true,
          "attract": {
            "enable": false,
            "rotateX": 600,
            "rotateY": 1200
          }
        }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": {
            "enable": true,
            "mode": "repulse"
          },
          "onclick": {
            "enable": false,
            "mode": "push"
          },
          "resize": true
        },
        "modes": {
          "grab": {
            "distance": 400,
            "line_linked": {
              "opacity": 1
            }
          },
          "bubble": {
            "distance": 400,
            "size": 40,
            "duration": 2,
            "opacity": 8,
            "speed": 3
          },
          "repulse": {
            "distance": 30,
            "duration": 0.4
          },
          "push": {
            "particles_nb": 1
          },
          "remove": {
            "particles_nb": 6
          }
        }
      },
      "retina_detect": true
    })

    const api = pJSDom[0].pJS.fn.modes

    var videoInput = document.getElementById('video');
    var ctracker = new clm.tracker();

    ctracker.init();
    ctracker.start(videoInput);

    function gumSuccess( stream ) {
      if ("srcObject" in videoInput) {
        videoInput.srcObject = stream;
      } else {
        videoInput.src = (window.URL && window.URL.createObjectURL(stream));
      }

      videoInput.onloadedmetadata = function() {
        videoInput.play();
        setTimeout(positionLoop, 100)
      }
    }

    function gumFail () {

    }

    if (navigator.mediaDevices) {
      navigator.mediaDevices.getUserMedia({video : true}).then(gumSuccess).catch(gumFail);
    } else if (navigator.getUserMedia) {
      navigator.getUserMedia({video : true}, gumSuccess, gumFail);
    } else {
      alert("Your browser does not seem to support getUserMedia, using a fallback video instead.");
    }

    function scale(positions, ix, scale) {

      const cx = window.pJSDom[0].pJS.canvas.w / 2
      const cy = window.pJSDom[0].pJS.canvas.h / 2

      const w = (positions[13][0] - positions[1][0]) / 2
      const h = (positions[13][1] - positions[1][1]) / 2

      const xs = 10//cx / w
      const xy = 10//cy / h

      //console.log(cx,w, 'x', cy,h, '|', xs,xy)

      const x = (((positions[ix][0] - positions[62][0]) * xs) * scale + cx)
      const y = (((positions[ix][1] - positions[62][1]) * xy) * scale + cy)

      return {x, y}
    }

    function repulse(positions, ix) {
      const pJS = pJSDom[0].pJS
      const fpos = scale(positions, ix, 1);

      for(let i =0; i< pJS.particles.array.length; i++) {
        const p = pJS.particles.array[i]

        var dx_mouse = p.x - fpos.x,
          dy_mouse = p.y - fpos.y,
          dist_mouse = Math.sqrt(dx_mouse * dx_mouse + dy_mouse * dy_mouse);

        var normVec = {x: dx_mouse / dist_mouse, y: dy_mouse / dist_mouse},
          repulseRadius = pJS.interactivity.modes.repulse.distance,
          velocity = 100,
          repulseFactor = clamp((1 / repulseRadius) * (-1 * Math.pow(dist_mouse / repulseRadius, 2) + 1) * repulseRadius * velocity, 0, 50);

        var pos = {
          x: p.x + normVec.x * repulseFactor,
          y: p.y + normVec.y * repulseFactor
        }

        p.x = pos.x;
        p.y = pos.y;
      }
    }

    function positionLoop() {
      var positions = ctracker.getCurrentPosition();
      if (positions) {
        const pJS = pJSDom[0].pJS
        pJS.particles.array.splice(pJS.particles.array.length - positions.length, positions.length);
        for (var p = 0;p < positions.length;p++) {
          let pt = scale(positions, p, 2);
          api.pushParticles(1, {pos_x: pt.x, pos_y: pt.y})
        }
      }
    }

    setInterval(positionLoop, 100)
  </script>
</div>
</body>
</html>